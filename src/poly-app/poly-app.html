<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-storage/app-network-status-behavior.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-in-animation.html">    
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">    
<link rel="import" href="../../bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../poly-add-contact-dialog/poly-add-contact-dialog.html">
<link rel="import" href="../poly-channel-list/poly-channel-list.html">
<link rel="import" href="../poly-contacts/poly-contacts.html">
<link rel="import" href="../poly-header/poly-header.html">
<link rel="import" href="../poly-logs/poly-logs.html">
<link rel="import" href="../poly-make-call-dialog/poly-make-call-dialog.html">
<link rel="import" href="../poly-message-dialog/poly-message-dialog.html">
<link rel="import" href="../poly-message-handler/poly-message-handler.html">
<link rel="import" href="../poly-message-list/poly-message-inbox.html">
<link rel="import" href="../poly-message-list/poly-message-outbox.html">
<link rel="import" href="../state-container.html">

<dom-module id="poly-app">
  <template>
    <style>

      :host {
        display: block;
      }

      paper-fab {
        position: fixed;
        right: 30px;
        bottom: 30px;
      }

    </style>

    <poly-message-handler 
      id         = "message-handler"
      on-open    = "handleConnectionOpened"
      on-close   = "handleConnectionClosed"
      on-message = "handleMessage"
      on-error   = "handleError">
    </poly-message-handler>

    <app-drawer-layout force-narrow>

      <app-drawer id="drawer" align="right"></app-drawer>

      <app-header-layout>

        <app-header fixed>
          <poly-header
            selected        = "{{selected}}"
            online          = "[[online]]"
            on-tap-settings = "handleToggleSettings">
          </poly-header>
        </app-header fixed>

        <neon-animated-pages selected="[[selected]]" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
          <neon-animatable>
            <poly-channel-list>
              <paper-fab on-tap="openMakeCallDialog" icon="communication:dialpad"></paper-fab>
            </poly-channel-list>
          </neon-animatable>
          <neon-animatable>
            <poly-message-inbox id="inbox">
              <paper-fab on-tap="openNewMessageDialog" icon="communication:message"></paper-fab>
            </poly-message-inbox>
          </neon-animatable>
          <neon-animatable>
            <poly-message-outbox id="outbox">
            </poly-message-outbox>
          </neon-animatable>
          <neon-animatable>
            <poly-logs></poly-logs>
          </neon-animatable>
          <neon-animatable>
            <poly-contacts>
              <paper-fab on-tap="openAddContactDialog" icon="create"></paper-fab>
            </poly-contacts>
          </neon-animatable>
        </neon-animated-pages>

      </app-header-layout>

    </app-drawer-layout>

    <poly-make-call-dialog id="make-call-dialog"></poly-make-call-dialog>
    <poly-message-dialog id="new-message-dialog"></poly-message-dialog>
    <poly-add-contact-dialog id="add-contact-dialog"></poly-add-contact-dialog>

  </template>

  <script>
    Polymer({

      is: 'poly-app',

      handleToggleSettings: function() {
        this.$.drawer.toggle();
      },

      handleConnectionOpened: function() {
        console.log('handleConnectionOpened()');
        this.$['message-handler'].send({
          event: 'inboxFetch',
          data: {
            filter: [], 
            after_id: null,
            count: null,
          }
        });
      },

      handleConnectionClosed: function() {
        console.log('handleConnectionClosed()');
      },

      handleMessage: function(event, payload) {
        switch (payload.event) {
          case 'initialize':
            var channels = payload.data.mixer.channels;
            this.getState().set('state.mixer.channels', 
              Object.keys(channels).map(function(key) {
                var channel = channels[key];
                channel.id = key;
                return channel;
              }));
            break;
          case 'inboxMessages':
            var messages = payload.data.messages;
            var ids = payload.data.ids,
                inbox  = [],
                outbox = [];
            ids.forEach(function(id) {
              var message = messages[id];
              message.id = id;
              if ('sms_in' === message.type) {
                inbox.push(message);
              } else {
                outbox.push(message);
              }
            });
            var state = this.getState();
            state.set('state.messages.inbox', inbox);
            state.set('state.messages.outbox', outbox);
            break;
          case 'inboxUpdate':
            break;
          case 'channelUpdate':
            break;
          default:
            console.warn('Unhandled message type: ' + payload.event);
        }
      },

      handleError: function() {
        console.log('handleError()');
      },

      openMakeCallDialog: function() {
        this.$['make-call-dialog'].open();
      },

      openNewMessageDialog: function() {
        this.$['new-message-dialog'].open();
      },

      openAddContactDialog: function() {
        this.$['add-contact-dialog'].open();
      },

      properties: {
        state: {
          type: Object,
          value: {
            mixer: {},
            messages: {
              inbox: [],
              outbox: [],
            },
          },
        },
      },

      behaviors: [
        Polymer.AppNetworkStatusBehavior, 
        ProviderBehavior,
        ReceiverBehavior,
      ],

    });
  </script>
</dom-module>
