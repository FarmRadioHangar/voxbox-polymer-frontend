<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-storage/app-network-status-behavior.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/polymer-redux/polymer-redux.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="poly-channel-list.html">
<link rel="import" href="poly-contacts.html">
<link rel="import" href="poly-header.html">
<link rel="import" href="poly-logs.html">
<link rel="import" href="poly-message-handler.html">
<link rel="import" href="poly-message-list.html">

<dom-module id="poly-app">
  <template>

    <style>

      :host {}

      app-header {
        height: 113px;
      }

      paper-fab {
        position: fixed;
        right: 30px;
        bottom: 30px;
      }

    </style>

    <poly-message-handler 
      id         = "messagehandler"
      on-open    = "handleConnectionOpened"
      on-close   = "handleConnectionClosed"
      on-message = "handleMessage"
      on-error   = "handleError">
    </poly-message-handler>

    <app-drawer-layout force-narrow>

      <app-drawer id="drawer" align="right"></app-drawer>

      <app-header-layout>

        <app-header fixed>
          <poly-header
            selected        = "{{selected}}"
            online          = "[[online]]"
            on-tap-settings = "handleToggleSettings">
          </poly-header>
        </app-header fixed>

        <iron-pages selected=[[selected]]>
          <poly-channel-list>
            <paper-fab icon="communication:phone"></paper-fab>
          </poly-channel-list>
          <poly-message-list>
            <paper-fab icon="communication:message"></paper-fab>
          </poly-message-list>
          <poly-logs></poly-logs>
          <poly-contacts>
            <paper-fab icon="create"></paper-fab>
          </poly-contacts>
        </iron-pages>

      </app-header-layout>

    </app-drawer-layout>

  </template>

  <script>
    Polymer({

      is: 'poly-app',

      ready() {
      },

      handleToggleSettings() {
        this.$.drawer.toggle();
      },

      handleConnectionOpened() {
        console.log('handleConnectionOpened');

        this.$.messagehandler.send({
          event: 'inboxFetch',
          data: {
            filter: [], 
            after_id: null,
            count: null
          }
        });
      },

      handleConnectionClosed() {
        console.log('handleConnectionClosed');
      },

      handleMessage(event, payload) {
        console.dir(payload);
        switch (payload.event) {
          case 'initialize':
            this.dispatch({
              type: 'APP_INITIALIZE',
              data: payload.data.mixer
            });

            break;
          case 'inboxMessages':
            this.dispatch({
              type: 'INBOX_MESSAGES',
              data: payload.data
            });
            break;
          default:
            console.warn('Unhandled message type: ' + payload.event);
        }
      },

      handleError() {
        console.log('handleError');
      },

      behaviors: [
        Polymer.AppNetworkStatusBehavior, 
        PolymerRedux(store)
      ]

    });
  </script>
</dom-module>
